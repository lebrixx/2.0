<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>La meilleure version de toi - lebrix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

  <style>
    :root { color-scheme: light; }
    html,body { height:100%; }
    body { font-family: 'Inter', sans-serif; background:#f1f5f9; color:#0f172a; }
    .brand-font { font-family: 'Playfair Display', serif; }
    .header-text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,.4); }

    /* Chrono plus grand et sur une seule ligne */
    #chrono {
      white-space: nowrap;
      display: inline-flex;
      align-items: baseline;
      gap: .5rem;
      line-height: 1;
      font-size: clamp(2rem, 4.5vw + .5rem, 3.75rem);
      letter-spacing: .01em;
    }
    #chrono .u { font-size: .75em; color: #64748b; }

    /* Pop-up pro */
    .modal-overlay { transition: opacity .25s ease; }
    .modal-card { transition: transform .22s ease, opacity .22s ease, box-shadow .22s ease; }
    .modal-card.show { transform: translateY(0); opacity: 1; }
    .modal-card.hide { transform: translateY(12px); opacity: 0; }

    /* Chips d‚Äôhabitudes : √©tat tr√®s lisible */
    .chip {
      position: relative;
      display: flex;
      align-items: center;
      gap: .5rem;
      width: 100%;
      padding: .75rem .9rem;
      border-radius: .75rem;
      border: 2px solid rgb(226,232,240); /* slate-200 */
      background: white;
      color: rgb(51,65,85); /* slate-700 */
      transition: border-color .18s ease, box-shadow .18s ease, transform .08s ease, background .18s ease, color .18s ease;
    }
    .chip:hover { border-color: rgb(203,213,225); box-shadow: 0 2px 10px rgba(2,6,23,.06); }
    .chip:active { transform: scale(.98); }
    .chip .tick {
      width: 22px; height: 22px; border-radius: 9999px;
      border: 2px solid rgb(203,213,225);
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 12px;
      transition: all .18s ease;
      background: white;
      color: transparent;
    }
    .chip.selected {
      border-color: rgb(79,70,229); /* indigo-600 */
      box-shadow: 0 0 0 4px rgba(79,70,229,.12);
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
      color: rgb(17,24,39); /* slate-900 */
    }
    .chip.selected .tick {
      background: rgb(79,70,229);
      border-color: rgb(79,70,229);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 1px 6px rgba(79,70,229,.45);
    }
    @keyframes pop {
      0% { transform: scale(.96); }
      100% { transform: scale(1); }
    }
    .chip.pop { animation: pop .12s ease-out; }

    /* Compteur de s√©lection */
    .select-counter {
      font-variant-numeric: tabular-nums;
    }
  </style>
</head>
<body class="text-slate-800">

  <div id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-3xl">
    <!-- Header -->
    <header class="relative bg-slate-800 text-white text-center rounded-xl shadow-lg overflow-hidden mb-8">
      <img src="https://images.unsplash.com/photo-1559827291-72ee739d0d9a?q=80&w=2574&auto=format&fit=crop"
           class="absolute h-full w-full object-cover opacity-40"
           alt="Paysage inspirant"
           onerror="this.style.display='none'">
      <div class="relative p-12 sm:p-16">
        <h1 id="main-title" class="text-4xl sm:text-5xl font-bold header-text-shadow brand-font leading-tight">
          La meilleure version de toi
        </h1>
        <p class="text-lg text-slate-200 mt-4 header-text-shadow">lebrix</p>
        <div class="mt-6">
          <button id="openChallengeBtn" class="px-6 py-3 bg-white bg-opacity-20 text-white font-bold rounded-lg hover:bg-opacity-30 transition duration-300 shadow-lg transform hover:scale-105 backdrop-blur-sm border border-white border-opacity-20">
            <i class="fas fa-star mr-2"></i> D√©fi du Jour
          </button>
        </div>
      </div>
    </header>

    <!-- Parcours -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-semibold text-slate-800 mb-2 text-center">Votre Parcours de Transformation</h2>
      <p class="text-sm text-slate-500 mb-6 text-center italic">Le temps √©coul√© depuis votre engagement et les paliers franchis.</p>

      <!-- Chrono -->
      <div class="text-center">
        <div id="chrono" class="mx-auto">
          <span id="months">0</span><span class="u">mois</span>
          <span id="days">0</span><span class="u">j</span>
          <span id="hours">00</span><span class="u">h</span>
          <span id="minutes">00</span><span class="u">m</span>
          <span id="seconds">00</span><span class="u">s</span>
        </div>
      </div>

      <hr class="my-6 border-slate-200">

      <!-- Frise -->
      <div>
        <h3 class="text-lg font-semibold text-slate-700 mb-8 text-center">Frise de Constance</h3>
        <div id="timeline-container" class="relative w-full h-16 flex items-center px-2">
          <div class="absolute w-full h-1 bg-slate-200 rounded-full left-0"></div>
          <div id="timeline-progress" class="absolute h-1 bg-slate-600 rounded-full left-0 transition-all duration-1000 ease-linear"></div>
          <div id="timeline-percentage" class="absolute bg-slate-700 text-white text-xs font-bold px-2 py-1 rounded-md -top-10 transition-all duration-1000 ease-linear whitespace-nowrap" style="left:0%;transform:translateX(-50%);">0%</div>
          <div id="timeline-nodes" class="relative w-full flex justify-between items-center"></div>
        </div>
      </div>

      <!-- Reset -->
      <div class="text-center mt-12">
        <button id="resetChronoBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300 text-sm shadow-sm">
          <i class="fas fa-undo mr-2"></i>R√©initialiser le Parcours
        </button>
      </div>
    </div>

    <!-- Citation -->
    <footer class="my-8 text-center">
      <p class="text-xl italic text-slate-600">"Comment rendre fiers tes proches si tu n'es pas d'abord fier de toi-m√™me ?"</p>
    </footer>

    <!-- Habitudes -->
    <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-1">
        <h2 class="text-2xl font-semibold text-slate-800">Mes Habitudes Quotidiennes</h2>
        <button id="resetTasksBtn" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition duration-300 text-sm">
          <i class="fas fa-sync-alt mr-2"></i>Nouvelle journ√©e
        </button>
      </div>
      <p class="text-sm text-slate-500 mb-6 italic">Coche tes actions pour construire la discipline. Tu peux modifier/ajouter/supprimer quand tu veux.</p>

      <ul id="taskList" class="space-y-3"></ul>

      <div class="mt-6 pt-6 border-t border-slate-200">
        <div class="flex flex-col sm:flex-row gap-2">
          <input type="text" id="newTaskInput" placeholder="Ajouter une nouvelle habitude..." class="flex-grow p-3 border-2 border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 transition">
          <button id="addTaskBtn" class="w-full sm:w-auto px-6 py-3 bg-slate-700 text-white font-semibold rounded-lg hover:bg-slate-800 transition duration-300 shadow-sm">Ajouter</button>
        </div>
      </div>
    </div>

    <!-- Citation dynamique -->
    <div class="mt-12 text-center border-t border-slate-300 pt-8">
      <div id="dynamic-quote-container" class="min-h-[150px] flex flex-col justify-center">
        <div>
          <p id="quote-text" class="text-xl italic text-slate-700"></p>
          <p id="quote-author" class="text-md text-slate-500 mt-2"></p>
        </div>
        <div class="w-24 h-1 bg-slate-200 rounded-full mx-auto mt-4 overflow-hidden">
          <div id="quote-progress-bar" class="h-1 bg-slate-500 rounded-full"></div>
        </div>
      </div>
    </div>

    <!-- Philosophie -->
    <div class="bg-white rounded-xl shadow-lg p-6 mt-12">
      <h2 class="text-2xl font-semibold text-slate-800 mb-4 text-center brand-font">La Philosophie de cet Espace</h2>
      <div class="text-slate-600 space-y-4 text-center max-w-2xl mx-auto">
        <p>Ce compteur n'est pas qu'un simple chronom√®tre. Il t√©moigne de votre engagement envers vous-m√™me.</p>
        <p>Le <b>Chrono</b> mesure l'engagement long terme. Les <b>Habitudes Quotidiennes</b> forgent la discipline. Le <b>D√©fi du Jour</b> vous pousse √† sortir de votre zone de confort.</p>
      </div>
    </div>
  </div>

  <!-- POP-UP (modale) pro pour les nouveaux -->
  <div id="onboardingModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 modal-overlay opacity-0 pointer-events-none">
    <div class="modal-card hide bg-white w-full max-w-xl mx-4 rounded-2xl shadow-2xl overflow-hidden">
      <!-- Bandeau motivant -->
      <div class="bg-gradient-to-r from-indigo-600 to-sky-600 text-white px-6 py-5">
        <h3 class="text-lg font-semibold brand-font">Bravo ‚Äî tu as fait le plus compliqu√© : <span class="underline decoration-white/60">commencer</span>.</h3>
        <p class="text-white/90 text-sm mt-1">On personnalise l‚Äôespace en 15 secondes.</p>
      </div>

      <!-- Corps -->
      <div class="p-6 sm:p-7">
        <label for="name-input" class="block text-sm font-medium text-slate-700">Ton pr√©nom</label>
        <input id="name-input" type="text" placeholder="Ex. Alex"
               class="mt-2 w-full p-3 border-2 border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-600">

        <div class="mt-6 flex items-baseline justify-between">
          <p class="text-sm font-medium text-slate-700">Choisis <b>2 √† 3</b> habitudes de d√©part</p>
          <span id="selectCounter" class="text-xs text-slate-500 select-counter">0/3</span>
        </div>

        <div id="habitChoices" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2.5">
          <!-- chips inject√©es via JS -->
        </div>

        <p class="text-xs text-slate-500 mt-3 italic">Tu pourras les modifier, en ajouter ou en supprimer ensuite.</p>

        <div id="errorMsg" class="hidden mt-3 text-sm text-red-600">Renseigne ton pr√©nom et choisis 2 √† 3 habitudes.</div>

        <button id="startBtn"
                class="mt-6 w-full px-6 py-3 bg-slate-900 text-white font-semibold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
          Enregistrer et commencer
        </button>
      </div>
    </div>
  </div>

  <!-- Modale D√©fi -->
  <div id="challengeModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 hidden modal-overlay opacity-0">
    <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md text-center transform scale-95 modal-content">
      <h2 class="text-2xl font-bold text-slate-800 brand-font">Votre D√©fi du Jour</h2>
      <p id="challengeText" class="text-slate-600 mt-4 mb-6 text-lg"></p>
      <button id="completeChallengeBtn" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-300 shadow-sm">
        <i class="fas fa-check mr-2"></i> J'ai r√©ussi !
      </button>
      <div class="mt-4">
        <p class="text-sm text-slate-500">S√©rie de constance : <span id="streakCounter" class="font-bold text-slate-700">0</span> jours</p>
        <p class="text-xs text-slate-400 mt-1">Temps restant pour ne pas briser la s√©rie : <span id="challengeTimer" class="font-bold"></span></p>
      </div>
      <button id="closeChallengeBtn" class="absolute top-3 right-3 text-slate-400 hover:text-slate-600">
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>
  </div>

  <!-- Modale Confirmation (inchang√©e) -->
  <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50 hidden modal-overlay opacity-0">
    <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-sm text-center transform scale-95 modal-content">
      <h2 id="confirmationTitle" class="text-xl font-bold text-slate-800"></h2>
      <p id="confirmationMessage" class="text-slate-600 mt-2 mb-6"></p>
      <div class="flex justify-center gap-4">
        <button id="confirmBtn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300">Confirmer</button>
        <button id="cancelBtn" class="px-6 py-2 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 transition duration-300">Annuler</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    // Utils
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
    const ls = {
      get: (k, fb=null) => {
        const v = localStorage.getItem(k);
        if (v===null || v===undefined) return fb;
        try { return JSON.parse(v); } catch { return v; }
      },
      set: (k, v) => localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v)),
      del: (k) => localStorage.removeItem(k)
    };

    // DOM principaux
    const mainTitle = $('#main-title');
    const taskList = $('#taskList');
    const newTaskInput = $('#newTaskInput');
    const addTaskBtn = $('#addTaskBtn');
    const resetTasksBtn = $('#resetTasksBtn');

    // Chrono
    const monthsEl = $('#months'), daysEl = $('#days'), hoursEl = $('#hours'), minutesEl = $('#minutes'), secondsEl = $('#seconds');
    const resetChronoBtn = $('#resetChronoBtn');

    // Timeline
    const timelineNodesContainer = $('#timeline-nodes');
    const timelineProgress = $('#timeline-progress');
    const timelinePercentage = $('#timeline-percentage');

    // D√©fi
    const openChallengeBtn = $('#openChallengeBtn');
    const challengeModal = $('#challengeModal');
    const challengeText = $('#challengeText');
    const completeChallengeBtn = $('#completeChallengeBtn');
    const streakCounter = $('#streakCounter');
    const closeChallengeBtn = $('#closeChallengeBtn');
    const challengeTimerEl = $('#challengeTimer');

    // Onboarding (pop-up)
    const onboardingModal = $('#onboardingModal');
    const modalCard = onboardingModal.querySelector('.modal-card');
    const nameInput = $('#name-input');
    const habitChoices = $('#habitChoices');
    const startBtn = $('#startBtn');
    const errorMsg = $('#errorMsg');
    const selectCounter = $('#selectCounter');

    // √âtat
    let tasks = [];
    let startTime = Number(ls.get('chronoStartTime'));
    if (!startTime || Number.isNaN(startTime)) {
      startTime = Date.now();
      ls.set('chronoStartTime', String(startTime));
    }

    // Habitudes propos√©es (4 + 3 nouvelles)
    const HABITS_PRESET = [
      "Boire de l'eau",
      "M√©diter 10 minutes",
      "Faire son lit",
      "Ranger sa chambre",
      "Lire 10 pages",
      "Marcher 15 min",
      "Respirer 3 minutes"
    ];

    // ----- Pop-up -----
    function renderHabitChoices(){
      habitChoices.innerHTML = '';
      HABITS_PRESET.forEach(text => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'chip';
        btn.setAttribute('aria-pressed','false');
        btn.innerHTML = `<span class="tick"><i class="fas fa-check"></i></span><span class="label">${text}</span>`;
        btn.dataset.selected = 'false';

        btn.addEventListener('click', () => {
          const currentlySelected = btn.dataset.selected === 'true';
          const selectedCount = $$('#habitChoices .chip').filter(c => c.dataset.selected === 'true').length;

          // S√©lection max 3
          if (!currentlySelected && selectedCount >= 3) return;

          btn.dataset.selected = String(!currentlySelected);
          btn.classList.toggle('selected', !currentlySelected);
          btn.classList.add('pop');
          btn.setAttribute('aria-pressed', String(!currentlySelected));
          setTimeout(()=>btn.classList.remove('pop'), 140);

          updateSelectCounter();
          validateOnboarding();
        });

        habitChoices.appendChild(btn);
      });
      updateSelectCounter();
    }

    function updateSelectCounter() {
      const count = $$('#habitChoices .chip').filter(c => c.dataset.selected === 'true').length;
      selectCounter.textContent = `${count}/3`;
    }

    function showOnboarding(){
      onboardingModal.classList.remove('pointer-events-none');
      onboardingModal.style.opacity = '1';
      modalCard.classList.remove('hide');
      modalCard.classList.add('show');
    }
    function hideOnboarding(){
      onboardingModal.style.opacity = '0';
      modalCard.classList.remove('show');
      modalCard.classList.add('hide');
      setTimeout(()=>onboardingModal.classList.add('pointer-events-none'), 220);
    }

    function validateOnboarding() {
      const nameOk = (nameInput.value || '').trim().length > 0;
      const selected = $$('#habitChoices .chip').filter(c => c.dataset.selected === 'true').map(c => c.querySelector('.label').textContent);
      const habitsOk = selected.length >= 2 && selected.length <= 3;
      startBtn.disabled = !(nameOk && habitsOk);
      if (nameOk && habitsOk) errorMsg.classList.add('hidden');
      return { nameOk, habitsOk, selected };
    }

    nameInput.addEventListener('input', validateOnboarding);

    startBtn.addEventListener('click', () => {
      const { nameOk, habitsOk, selected } = validateOnboarding();
      if (!nameOk || !habitsOk) {
        errorMsg.classList.remove('hidden');
        return;
      }
      const name = nameInput.value.trim();

      // Sauvegarde
      ls.set('userName', name);
      const mapped = selected.map(t => ({ text: t, checked: false }));
      const existing = ls.get('tasks', []);
      if (!existing || !Array.isArray(existing) || existing.length === 0) {
        ls.set('tasks', mapped);
      }

      loadUserData();
      renderTasks();
      hideOnboarding();
    });

    // ----- Donn√©es & rendu -----
    function loadUserData(){
      const userName = ls.get('userName', '');
      if (userName && typeof userName === 'string' && userName.trim().toLowerCase() !== 'vous') {
        mainTitle.textContent = `La meilleure version de ${userName}`;
      } else {
        mainTitle.textContent = 'La meilleure version de toi';
      }
      const savedTasks = ls.get('tasks', []);
      tasks = Array.isArray(savedTasks) ? savedTasks : [];
    }
    function saveTasks(){ ls.set('tasks', tasks); }

    // T√¢ches
    function renderTasks(){
      taskList.innerHTML = '';
      if (!tasks.length) {
        taskList.innerHTML = '<p class="text-slate-500 text-center py-4">Aucune habitude pour le moment. Ajoute-en une üëá</p>';
        return;
      }
      tasks.forEach((task, index) => {
        const li = document.createElement('li');
        li.className = `task-item flex items-center bg-slate-50 p-3 rounded-lg transition duration-300 hover:bg-slate-100 ${task.checked?'opacity-60':''}`;
        li.innerHTML = `
          <input type="checkbox" id="task-${index}" class="h-5 w-5 rounded border-slate-300 text-slate-600 focus:ring-indigo-600 cursor-pointer" ${task.checked?'checked':''}>
          <label for="task-${index}" class="ml-3 flex-grow text-slate-700 cursor-pointer ${task.checked?'line-through text-slate-400':''}">${task.text}</label>
          <button class="delete-btn text-red-500 ml-2 hover:text-red-700 transition-colors duration-200" aria-label="Supprimer la t√¢che" data-index="${index}">
            <i class="fas fa-trash-alt"></i>
          </button>
        `;
        taskList.appendChild(li);

        li.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
          tasks[index].checked = e.target.checked;
          saveTasks();
          renderTasks();
        });
        li.querySelector('.delete-btn').addEventListener('click', () => {
          tasks.splice(index, 1);
          saveTasks();
          renderTasks();
        });
      });
    }

    function addTask(){
      const text = newTaskInput.value.trim();
      if (text) {
        tasks.push({ text, checked:false });
        newTaskInput.value = '';
        saveTasks();
        renderTasks();
      }
    }
    addTaskBtn.addEventListener('click', addTask);
    newTaskInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') addTask(); });
    resetTasksBtn.addEventListener('click', () => {
      tasks.forEach(t => t.checked = false);
      saveTasks();
      renderTasks();
    });

    // Chrono
    function updateChrono(){
      const now = Date.now();
      const elapsed = now - startTime;
      const avgDaysInMonth = 30.4375;
      const totalDaysRaw = elapsed / 86400000;

      const months = Math.floor(totalDaysRaw / avgDaysInMonth);
      const days   = Math.floor(totalDaysRaw % avgDaysInMonth);
      const hours  = Math.floor((elapsed % 86400000) / 3600000);
      const mins   = Math.floor((elapsed % 3600000) / 60000);
      const secs   = Math.floor((elapsed % 60000) / 1000);

      monthsEl.textContent  = months;
      daysEl.textContent    = days;
      hoursEl.textContent   = String(hours).padStart(2,'0');
      minutesEl.textContent = String(mins).padStart(2,'0');
      secondsEl.textContent = String(secs).padStart(2,'0');

      updateTimeline(elapsed);
    }
    resetChronoBtn.addEventListener('click', () => {
      startTime = Date.now();
      ls.set('chronoStartTime', String(startTime));
      updateChrono();
    });

    // Frise
    const DAY=86400000, WEEK=DAY*7, MONTH=DAY*30.4375, YEAR=DAY*365.25;
    const objectives = [
      { label:'1 Jour', duration: DAY },
      { label:'1 Sem.', duration: WEEK },
      { label:'2 Sem.', duration: WEEK*2 },
      { label:'3 Sem.', duration: WEEK*3 },
      { label:'1 Mois', duration: MONTH },
      { label:'6 Mois', duration: MONTH*6 },
      { label:'1 An',   duration: YEAR }
    ];
    function renderTimelineStructure(){
      timelineNodesContainer.innerHTML = '';
      objectives.forEach((obj, i) => {
        const nodeEl = document.createElement('div');
        nodeEl.className = 'relative flex flex-col items-center';
        const labelPos = i % 2 === 0 ? '-bottom-7' : '-top-7';
        nodeEl.innerHTML = `
          <div id="timeline-node-${i}" class="w-3 h-3 bg-slate-200 rounded-full border-2 border-slate-200 transition-colors duration-500 z-10"></div>
          <span class="absolute ${labelPos} text-xs text-slate-500 whitespace-nowrap">${obj.label}</span>
        `;
        timelineNodesContainer.appendChild(nodeEl);
      });
    }
    function updateTimeline(elapsed){
      const yearDur = objectives[objectives.length-1].duration;
      const progressPct = Math.min(100, (elapsed / yearDur) * 100);
      timelineProgress.style.width = `${progressPct}%`;

      if (elapsed >= yearDur) {
        timelinePercentage.style.left = '100%';
        timelinePercentage.textContent = "Compl√©t√© !";
        objectives.forEach((_, i) => {
          const n = document.getElementById(`timeline-node-${i}`);
          if (n){ n.classList.add('bg-slate-600'); n.classList.remove('bg-slate-200'); }
        });
        return;
      }

      let lastDur = 0, nextObj = objectives[0];
      for (let i=0;i<objectives.length;i++){
        const node = document.getElementById(`timeline-node-${i}`);
        if (elapsed >= objectives[i].duration) {
          lastDur = objectives[i].duration;
          if (i+1 < objectives.length) nextObj = objectives[i+1];
          if(node){ node.classList.remove('bg-slate-200'); node.classList.add('bg-slate-600'); }
        } else {
          if(node){ node.classList.add('bg-slate-200'); node.classList.remove('bg-slate-600'); }
        }
      }
      const segmentTotal = nextObj.duration - lastDur;
      const segElapsed = Math.max(0, elapsed - lastDur);
      const segPct = Math.min(100, (segElapsed / segmentTotal) * 100);
      timelinePercentage.textContent = `${Math.floor(segPct)}% vers ${nextObj.label}`;
      timelinePercentage.style.left = `${progressPct}%`;
    }

    // D√©fi du jour (r√©sum√©)
    const quotes = [
      { text: "Connais-toi toi-m√™me.", author: "Socrate" },
      { text: "La discipline est le pont entre les objectifs et leur r√©alisation.", author: "Jim Rohn" }
    ];
    const challenges = [
      "Fais ton max de pompes.", "Tiens la planche le plus longtemps possible.",
      "Bois 2 litres d'eau aujourd'hui.", "√âcris 3 choses positives de la journ√©e."
    ];
    const quoteTextEl = $('#quote-text'), quoteAuthorEl = $('#quote-author'), quoteProgressBar = $('#quote-progress-bar');
    function updateQuote(){
      const i = Math.floor(Math.random()*quotes.length);
      const q = quotes[i];
      quoteTextEl.textContent = `"${q.text}"`;
      quoteAuthorEl.textContent = `‚Äî ${q.author}`;
      quoteProgressBar.classList.remove('progress-bar-fill'); void quoteProgressBar.offsetWidth; quoteProgressBar.classList.add('progress-bar-fill');
    }
    function getTodayDateString(){ return new Date().toISOString().split('T')[0]; }
    function getChallengeForToday(){
      const epochDays = Math.floor(Date.now()/86400000);
      return challenges[epochDays % challenges.length];
    }
    function updateChallengeTimer(){
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(tomorrow.getDate()+1);
      tomorrow.setHours(0,0,0,0);
      const diff = Math.max(0, tomorrow - now);
      const DAY = 24*60*60*1000;
      const h = String(Math.floor((diff % (DAY)) / (1000*60*60))).padStart(2,'0');
      const m = String(Math.floor((diff % (1000*60*60)) / (1000*60))).padStart(2,'0');
      const s = String(Math.floor((diff % (1000*60)) / 1000)).padStart(2,'0');
      challengeTimerEl.textContent = `${h}:${m}:${s}`;
    }
    function updateChallengeUI(){
      const today = getTodayDateString();
      const ch = ls.get('challengeData', { lastCompleted:null, streak:0 });
      challengeText.textContent = getChallengeForToday();
      streakCounter.textContent = ch.streak || 0;

      const completed = ch.lastCompleted === today;
      completeChallengeBtn.disabled = completed;
      if (completed) {
        completeChallengeBtn.textContent = "D√©fi du jour accompli !";
        completeChallengeBtn.classList.add('bg-slate-400');
        completeChallengeBtn.classList.remove('bg-green-600','hover:bg-green-700');
      } else {
        completeChallengeBtn.innerHTML = '<i class="fas fa-check mr-2"></i> J\'ai r√©ussi !';
        completeChallengeBtn.classList.remove('bg-slate-400');
        completeChallengeBtn.classList.add('bg-green-600','hover:bg-green-700');
      }
    }
    let challengeInterval=null;
    openChallengeBtn.addEventListener('click', () => {
      updateChallengeUI();
      updateChallengeTimer();
      if (challengeInterval) clearInterval(challengeInterval);
      challengeInterval = setInterval(updateChallengeTimer, 1000);
      challengeModal.classList.remove('hidden');
      requestAnimationFrame(()=> {
        challengeModal.classList.remove('opacity-0');
        $('.modal-content', challengeModal).classList.remove('scale-95');
      });
    });
    closeChallengeBtn.addEventListener('click', closeChallengeModal);
    function closeChallengeModal(){
      if (challengeInterval) { clearInterval(challengeInterval); challengeInterval = null; }
      challengeModal.classList.add('opacity-0');
      $('.modal-content', challengeModal).classList.add('scale-95');
      setTimeout(()=> challengeModal.classList.add('hidden'), 250);
    }
    completeChallengeBtn.addEventListener('click', () => {
      const today = getTodayDateString();
      const yesterday = new Date(Date.now()-86400000).toISOString().split('T')[0];
      let data = ls.get('challengeData', { lastCompleted:null, streak:0 }) || { lastCompleted:null, streak:0 };
      if (data.lastCompleted === yesterday) data.streak = (data.streak||0) + 1;
      else if (data.lastCompleted !== today) data.streak = 1;
      data.lastCompleted = today;
      ls.set('challengeData', data);
      updateChallengeUI();
    });

    // Init
    function initialize(){
      loadUserData();
      renderTasks();
      renderTimelineStructure();
      updateQuote();
      updateChrono();
      setInterval(updateChrono, 1000);
      setInterval(updateQuote, 10000);

      // Affiche la pop-up si nouveau
      const hasName = !!ls.get('userName','');
      const hasTasks = Array.isArray(ls.get('tasks', [])) && ls.get('tasks', []).length > 0;
      if (!hasName || !hasTasks) {
        renderHabitChoices();
        showOnboarding();
        validateOnboarding();
      }
    }

    // Frise structure
    function renderTimelineStructure(){
      timelineNodesContainer.innerHTML = '';
      objectives.forEach((obj, i) => {
        const nodeEl = document.createElement('div');
        nodeEl.className = 'relative flex flex-col items-center';
        const labelPos = i % 2 === 0 ? '-bottom-7' : '-top-7';
        nodeEl.innerHTML = `
          <div id="timeline-node-${i}" class="w-3 h-3 bg-slate-200 rounded-full border-2 border-slate-200 transition-colors duration-500 z-10"></div>
          <span class="absolute ${labelPos} text-xs text-slate-500 whitespace-nowrap">${obj.label}</span>
        `;
        timelineNodesContainer.appendChild(nodeEl);
      });
    }

    initialize();
  })();
  </script>
</body>
</html>
